name: Test Patches

on:
  pull_request:
    types: [opened]
  workflow_dispatch:

jobs:
  test:
    if: github.actor == 'dependabot[bot]' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
        - name: Test patches
      id: test
      run: |
        echo "🧪 Running patch tests..."

        # Run the test script and capture exit code
        if ./scripts/test-patches.sh; then
          echo "status=pass" >> $GITHUB_OUTPUT
          echo "✅ All patch tests passed"
        else
          echo "status=fail" >> $GITHUB_OUTPUT
          echo "❌ Patch tests failed"

          # Show test output for debugging
          echo "📋 Test output:"
          cat patch_output.log 2>/dev/null || echo "No patch log found"
        fi
    
    # Only set labels, don't try to comment (no permissions)
    - name: Label PR
      if: github.event_name == 'pull_request' && steps.test.outputs.status == 'fail'
      uses: actions/github-script@v7
      continue-on-error: true  # Don't fail the workflow if labeling fails
      with:
        script: |
          try {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['patches-broken']
            });
            console.log('Added patches-broken label');
          } catch (error) {
            console.log('Unable to add label (expected for Dependabot PRs):', error.message);
          }
    
    # Create an artifact with the test results that can be viewed
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: patch-test-results
        path: build.log
        retention-days: 7
    
    # Set workflow status based on test result
    - name: Set workflow status
      if: steps.test.outputs.status == 'fail'
      run: |
        echo "::error::Patches are broken for this Claude version"
        exit 1