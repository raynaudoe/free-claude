name: Test Patches

on:
  pull_request:
    types: [opened]
  workflow_dispatch:

jobs:
  test:
    if: github.actor == 'dependabot[bot]' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Test patches
      id: test
      run: |
        docker build -t test . -q
        OUTPUT=$(docker run --rm test 2>&1)
        echo "$OUTPUT"
        
        if echo "$OUTPUT" | grep -q "Sub-agent recursion: ENABLED"; then
          echo "status=pass" >> $GITHUB_OUTPUT
        else
          echo "status=fail" >> $GITHUB_OUTPUT
        fi
    
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const passed = '${{ steps.test.outputs.status }}' === 'pass';
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: passed ? 
              '✅ Patches working - closing PR' : 
              '❌ **Patches BROKEN - need fix!**'
          });
          
          if (passed) {
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              state: 'closed'
            });
          } else {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['patches-broken']
            });
          }